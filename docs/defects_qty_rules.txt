ИНСТРУКЦИЯ
Расширение функционала расчёта объёмов дефектов
===============================================

ОБЩАЯ ИДЕЯ
----------
Расчёт объёмов дефектов управляется через параметр qty_rule,
который хранится в базе данных у каждого дефекта.

Код смотрит на qty_rule и выполняет соответствующую формулу.
Все расчёты находятся в одном месте — в методе calculate_qty().


1. ЧТО НУЖНО ЗАДАТЬ В БАЗЕ ДАННЫХ
--------------------------------
Для каждого дефекта в таблице defect_types используются поля:

- units     — единицы измерения (м, м², шт и т.п.)
- qty_rule  — строковый код правила расчёта

Примеры qty_rule:
- DECK_AREA_G
- SIDEWALK_AREA_T
- BEAM_LENGTH
- PIER_HEIGHT
- MANUAL   (если расчёта нет, ввод вручную)

Другие поля БД менять не нужно.


2. ГДЕ В КОДЕ ДОБАВЛЯЕТСЯ РАСЧЁТ
--------------------------------
Все расчёты реализуются в одном методе:

tabs/tab_defects.py
    def calculate_qty(self):

Внутри используется конструкция:
    if rule == "...":
    elif rule == "...":


3. КАК ДОБАВИТЬ НОВЫЙ РАСЧЁТ
---------------------------
Пример: расчёт высоты опоры (PIER_HEIGHT)

Шаг 1. В БД:
- units = "м"
- qty_rule = "PIER_HEIGHT"

Шаг 2. В коде (calculate_qty):

elif rule == "PIER_HEIGHT":
    h = _to_float(bridge.get("pier_height", ""))
    if h is None:
        messagebox.showwarning(
            "Недостаточно данных",
            "Для расчёта нужно заполнить высоту опоры"
        )
        return

    self.qty_entry.delete(0, tk.END)
    self.qty_entry.insert(0, f"{h:.2f}".replace(".", ","))


4. АВТОМАТИЧЕСКАЯ БУКВА ПЕРЕД "="
--------------------------------
Буква перед "=" подставляется автоматически по units:

- м² → F (площадь)
- м  → L (длина)
- мм/см → T (глубина, толщина)
- шт → N (количество)

Логика находится в методе:
    _qty_prefix_by_unit(unit)

Если нужно добавить новый тип — править только этот метод.


5. ЕСЛИ РАСЧЁТА НЕТ
-------------------
Для дефектов без формулы:
- qty_rule = "MANUAL"
- кнопка «Рассчитать» отключена
- значение вводится вручную


6. КРАТКИЙ ЧЕКЛИСТ
------------------
[ ] Добавил дефект → задал units
[ ] Нужен расчёт → задал qty_rule
[ ] Новый принцип расчёта → добавил elif в calculate_qty
[ ] Новая буква (F/L/T/...) → дополнил _qty_prefix_by_unit


ПРИМЕЧАНИЕ
----------
Всю логику расчёта держать только:
- в БД (units, qty_rule)
- в calculate_qty()

Не размазывать расчёты по другим частям программы.